{% extends 'template.html' %}

{% load static %}

{% block title %}
Viltrum | Chat
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'chat/css/chat.css' %}">
{% endblock %}

{% block content %}
<div class="chat-page">
    <ul class="chat-thread" id="chat-messages">
        {% for message in chat_messages %}
        <li class="message {% if message.author.username == user.username %}outgoing{% else %}incoming{% endif %}">
            <img class="avatar" src="{{ message.author.profile_image }}" alt="{{ message.author.username }}">
            <div class="message-content">
                <strong class="message-author">{{ message.author.username }}</strong>
                <span class="message-body">{{ message.body }}</span>
            </div>
        </li>
        {% empty %}
        <p class="no-messages">No hay mensajes aún por leer.</p>
        {% endfor %}
    </ul>

    <div class="chat-input-container">
        <form id="chat-messages_form">
            {% csrf_token %}
            <select name="language" id="language">
                <option value="ingles">Ingles</option>
                <option value="español">Español</option>
                <option value="ruso">Ruso</option>
                <option value="japones">Japones</option>
                <option value="frances">Frances</option>
                <option value="italiano">Italiano</option>
                <option value="portugues">Portugues</option>
            </select>
            <input class="chat-window-message styled-input" id="message-input" name="body" type="text" placeholder="Escribe un mensaje..." required autofocus />
            <button type="submit" class="send-button">Enviar</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const chatSocket = new WebSocket(`ws://${window.location.host}/ws/chatroom/{{ chatroom_name }}`);
    
    chatSocket.onopen = function (e) {
        console.log("Conectado al WebSocket de Chat");
    };

    chatSocket.onmessage = function (event) {
        const data = JSON.parse(event.data);

        if (data.error) {
            console.error(data.error); 
            return;
        }

        const chatMessages = document.getElementById('chat-messages');
        const newMessage = document.createElement('li');
        newMessage.className = "message incoming"; 

        const avatar = document.createElement('img');
        avatar.className = "avatar";
        avatar.src = data.author_profile_image;

        const messageContent = document.createElement('div');
        messageContent.className = "message-content";

        const authorStrong = document.createElement('strong');
        authorStrong.className = "message-author";
        authorStrong.textContent = data.author + ': '; 

        const messageBody = document.createElement('span');
        messageBody.className = "message-body";
        messageBody.textContent = data.message;

        messageContent.appendChild(authorStrong);
        messageContent.appendChild(messageBody);
        newMessage.appendChild(avatar);
        newMessage.appendChild(messageContent);
        chatMessages.appendChild(newMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    chatSocket.onclose = function (event) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('chat-messages_form').addEventListener('submit', function (event) {
        event.preventDefault(); 
        const messageInput = document.getElementById('message-input');
        const language = document.getElementById('language');

        if (messageInput.value.trim() !== "") {
            chatSocket.send(JSON.stringify({
                'body': messageInput.value.trim(),
                'language': language.value.trim()
            }));
            messageInput.value = ""; 
        }
    });
</script>
{% endblock %}
