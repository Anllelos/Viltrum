{% extends 'template.html' %}

{% load static %}

{% block title %}
Viltrum | Perfil {{ profile_user.username }}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/myProfile.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
    html,
    body {
        height: 100%;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Añadimos el canvas para la nebulosa animada -->
<canvas id="nebulaCanvas"></canvas>

<div class="profile-container">
    <!-- Encabezado del perfil -->
    <div class="profile-header">
        <div class="profile-banner">
            <img src="{% if profile.profile_banner %}{{ profile.profile_banner.url }}{% else %}https://via.placeholder.com/770x200{% endif %}"
                alt="Banner">
        </div>

        <!-- Imagen de perfil -->
        <div class="profile-image">
            <img src="{% if profile.profile_img %}{{ profile.profile_img.url }}{% else %}https://ui-avatars.com/api/?name={{ profile_user.username }}{% endif %}"
                alt="Foto de perfil">
        </div>
    </div>

    <!-- Íconos debajo del banner -->
    {% if profile.user != user %}
    <div class="interactions-buttons">
        <a href="{% url 'start_chat' profile.user %}" class="message-button"><i class="fa-solid fa-message"></i></i></a>
        {% if role == 'sponsor'%}
        {% if notify_sended %}
        <button class="match-button" id="notificationForm" disabled>
            <i class="fa fa-check-circle"></i> Notificación enviada
        </button>
        {% else %}
        <button class="match-button" id="notificationForm" onclick="sendInvitationNotify(this)">
            <i class="fa fa-check-circle"></i> Conectar
        </button>
        {% endif %}
        {% endif %}
    </div>
    {% endif %}

    <!-- Información del usuario -->
    <div class="text-center">
        <h2 class="username">{{ profile_user.username }}</h2>
        {% if profile.user_verification %}
        <i class="bi bi-check-circle-fill fs-4 verificado"></i>
        {% endif %}
        <p class="user-description">{{ profile.user_description|default:"El usuario no ha agregado información aún." }}
        </p>
    </div>

    <div>
        <h2>Mis sponsors</h2>
        <div class="sponsors">
            {% for sponsor in sponsors %}
            <a href="{% url 'profile_sponsor' sponsor.sponsor %}" class="btn cube cube-hover" type="button">
                <div class="bg-top">
                    <div class="bg-inner"></div>
                </div>
                <div class="bg-right">
                    <div class="bg-inner"></div>
                </div>
                <div class="bg">
                    <div class="bg-inner"></div>
                </div>
                <div class="text">{{sponsor.sponsor}}</div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Sección de juegos -->
    <div class="gallery-container">
        <!-- Mostrar las tarjetas de juegos -->
        <div class="grid grid-cols-2 md:grid-cols-4 g-4">
            {% for game in games %}
            <div class="game-card">
                <h3 class="game-title">{{ game.game }}</h3>
                <div class="game-info">
                    <span><strong>Usuario:</strong> {{ game.user_game }}</span>
                    <span><strong>Rango:</strong> {{ game.rank }}</span>
                    <span><strong>Winrate:</strong> {{ game.winrate|floatformat:2 }}%</span>
                    <span><strong>Total Jugado:</strong> {{ game.total_played }}</span>
                </div>
            </div>
            {% empty %}
            <p class="text-center col-span-4">Aún no has subido ningún juego.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Enlaces a redes sociales -->
    <div class="profile-footer text-center mt-5">
        <a href="#"><i class="bi bi-facebook"></i> Facebook</a>
        <a href="#"><i class="bi bi-twitter"></i> Twitter</a>
        <a href="#"><i class="bi bi-instagram"></i> Instagram</a>
        <a href="#"><i class="bi bi-youtube"></i> YouTube</a>
        <a href="#"><i class="bi bi-twitch"></i> Twitch</a>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function confirmDeletion() {
        if (confirm("¿Estás seguro de que deseas eliminar estas estadísticas de juego?")) {
            document.getElementById("deleteForm").submit();
        }
    }
</script>
{% if user.is_authenticated and role == 'sponsor'%}
<script>
    const receiver = "{{ profile.id }}";
    function sendInvitationNotify(button) {
        button.disabled = true;
        const message = "¡Un patrocinador quiere colaborar contigo!, {{ user }}";
        // Enviar el mensaje al WebSocket
        notificationSocket.send(JSON.stringify({
            "message": message,
            "receiver": receiver,
            "type": "sponsorship"
        }));
    };
</script>
{% endif %}

<!-- Añadimos el JavaScript para la nebulosa animada -->
<script>
    // Código JavaScript para la nebulosa animada
    const canvas = document.getElementById("nebulaCanvas");
    const ctx = canvas.getContext("2d");

    let width, height;
    let nebulaClouds = [];
    let stars = [];

    class Star {
        constructor() {
            this.reset();
        }

        reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.size = Math.random() * 2 + 0.5;
            this.speed = Math.random() * 0.20 + 0.18;
            this.brightness = Math.random();
        }

        update() {
            this.y -= this.speed;
            if (this.y < 0) {
                this.reset();
                this.y = height;
            }
            this.brightness = Math.sin(Date.now() * this.speed * 0.01) * 0.5 + 0.5;
        }

        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255, 255, 255, ${this.brightness})`;
            ctx.fill();
        }
    }

    class NebulaCloud {
        constructor() {
            this.reset();
        }

        reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.radius = Math.random() * 300 + 150;
            this.color = this.getRandomColor();
            this.points = this.generatePoints();
            this.angle = 0;
            this.rotationSpeed = (Math.random() - 0.5) * 0.001;
        }

        getRandomColor() {
            const colors = [
                "rgba(65, 105, 225, 0.1)", // Royal Blue
                "rgba(138, 43, 226, 0.1)", // Blue Violet
                "rgba(255, 20, 147, 0.1)", // Deep Pink
                "rgba(75, 0, 130, 0.1)", // Indigo
                "rgba(147, 112, 219, 0.1)", // Medium Purple
                "rgba(218, 112, 214, 0.1)" // Orchid
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        generatePoints() {
            const numberOfPoints = 12;
            const angleStep = (Math.PI * 2) / numberOfPoints;
            const points = [];

            for (let i = 0; i <= numberOfPoints; i++) {
                const angle = i * angleStep;
                const distortion = Math.random() * 0.5 + 0.5;
                const x = Math.cos(angle) * this.radius * distortion;
                const y = Math.sin(angle) * this.radius * distortion;
                points.push({ x, y });
            }

            return points;
        }

        update() {
            this.angle += this.rotationSpeed;
        }

        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle);

            ctx.beginPath();
            ctx.moveTo(this.points[0].x, this.points[0].y);
            for (let i = 1; i < this.points.length; i++) {
                ctx.lineTo(this.points[i].x, this.points[i].y);
            }
            ctx.closePath();

            const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.radius);
            gradient.addColorStop(0, this.color);
            gradient.addColorStop(1, "transparent");

            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = "screen";
            ctx.fill();

            ctx.restore();
        }
    }

    function createStars() {
        stars = [];
        for (let i = 0; i < 300; i++) {
            stars.push(new Star());
        }
    }

    function createNebulaClouds() {
        nebulaClouds = [];
        for (let i = 0; i < 8; i++) {
            nebulaClouds.push(new NebulaCloud());
        }
    }

    function drawBackground() {
        const gradient = ctx.createRadialGradient(
            width / 2,
            height / 2,
            0,
            width / 2,
            height / 2,
            Math.max(width, height) / 2
        );
        gradient.addColorStop(0, "#0c0d1d");
        gradient.addColorStop(1, "#000000");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);
    }

    function animate() {
        ctx.clearRect(0, 0, width, height);

        drawBackground();

        nebulaClouds.forEach((cloud) => {
            cloud.update();
            cloud.draw();
        });

        stars.forEach((star) => {
            star.update();
            star.draw();
        });

        requestAnimationFrame(animate);
    }

    function resizeCanvas() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        createStars();
        createNebulaClouds();
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    animate();
</script>
{% endblock %}